<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Audio Stream Client</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1c1c2b; color: #e0e0e0; }
        h2 { color: #00f0ff; }
        .controls { margin-top: 20px; }
        button { padding: 10px 20px; margin: 5px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        #startBtn { background: #00f0ff; color: #041726; }
        #stopBtn { background: #ff4757; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { margin-top: 15px; padding: 10px; border-radius: 4px; }
        .error { background: #ff4757; color: white; }
        .success { background: #2ed573; color: #041726; }
    </style>
</head>
<body>
    <h2>Audio Stream Client</h2>
    <audio id="player" autoplay controls></audio>
    <div class="controls">
        <button id="startBtn" onclick="start()">Start Streaming</button>
        <button id="stopBtn" onclick="stop()" disabled>Stop Streaming</button>
    </div>
    <div id="status"></div>

    <script>
        let pc = null;
        // Use same host but port 9000 for audio server
        const AUDIO_SERVER_URL = window.location.protocol + '//' + window.location.hostname + ':9000';

        function showStatus(msg, isError = false) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = isError ? 'error' : 'success';
        }

        async function start() {
            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;
            showStatus('Connecting to audio server...');

            try {
                pc = new RTCPeerConnection();

                pc.ontrack = (event) => {
                    document.getElementById("player").srcObject = event.streams[0];
                    showStatus('Audio connected successfully!');
                };

                pc.oniceconnectionstatechange = () => {
                    console.log('ICE state:', pc.iceConnectionState);
                    if (pc.iceConnectionState === 'failed') {
                        showStatus('Connection failed. Click Start to retry.', true);
                        stop();
                    } else if (pc.iceConnectionState === 'connected') {
                        showStatus('Audio connected successfully!');
                    }
                };

                pc.addTransceiver('audio', { direction: 'recvonly' });

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                console.log('Connecting to:', AUDIO_SERVER_URL + '/offer');
                const response = await fetch(AUDIO_SERVER_URL + '/offer', {
                    method: "POST",
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type
                    }),
                    headers: { "Content-Type": "application/json" }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const answer = await response.json();
                await pc.setRemoteDescription(answer);
            } catch (error) {
                console.error('Failed to start audio:', error);
                showStatus('Failed to connect: ' + error.message, true);
                stop();
            }
        }

        function stop() {
            if (pc) {
                pc.close();
                pc = null;
            }
            document.getElementById("player").srcObject = null;
            document.getElementById("startBtn").disabled = false;
            document.getElementById("stopBtn").disabled = true;
        }
    </script>
</body>

</html>
